---
title: "Materials Needed"
author: "Factory - Pak Eddie"
date: "19 August 2021, Updated `r format(Sys.Date(), '%d %B %Y')`"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    toc_depth: 2
    css: style.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE)

# load packages
library(tidyverse)
library(here)
library(DT)
```

The main data tables in this report can be viewed in google sheets [here](https://docs.google.com/spreadsheets/d/1Fwp5bj1Q6TyonGrFc_UbmCjGx5BnOrHNWFhvGsx0-A0/edit?usp=sharing). See `calculations` tabs.

```{r data-[preparation}
filename = "materials.xlsx"

# import data
df_raw <- readxl::read_xlsx(here("data", filename))

# extra additions
xt_add <-
  df_raw %>% 
  select(model, ends_with("_xt_add")) %>% 
  pivot_longer(cols = ends_with("_xt_add"),
               names_to = "type",
               values_to = "length") %>% 
  dplyr::filter(! is.na(length))

# multiplier
multiplier <- 
  df_raw %>% 
  select(model, ends_with("_multiplier")) %>% 
  pivot_longer(cols = ends_with("_multiplier"),
               names_to = "type",
               values_to = "multiplier") %>% 
  mutate(type = stringr::str_remove(type, "_multiplier"))

# clean main dataframe
df <- 
  df_raw %>% 
  # remove extra additions and multiplier
  select(-ends_with("_xt_add"), -ends_with("_multiplier")) %>% 
  # pivot longer (tidy data)
  pivot_longer(cols = -model,
               names_to = "type",
               values_to = "length") %>% 
  # join with multiplier
  left_join(multiplier, by = c("model", "type")) %>% 
  # expand multiplier using uncount()
  uncount(weights = multiplier) %>% 
  # join with extra additions
  full_join(xt_add, by = c("model", "type", "length")) %>% 
  # remove length = NA
  dplyr::filter(! is.na(length)) %>% 
  separate(type, c("primary", "type"), "_", extra = "merge")
```


## Materials Needed {.tabset}

The tables below gives the calculation for materials needed when grouped by model, type and length. 

5 additional columns have been added. They are:

1. **Each Bar (6m) Gives**: The number of pieces each bar can give for the particular length
2. **Number of Bars Needed**: How many bars is required to fulfill the requirement for that length
3. **Total Remainder Length**: This is calculated by:
    $$(6 \times bar \ needed) - (length \times n) \\
    or \\ 
    (remainder \ at \ max \ cap \times bar \ needed) + unused \ capacity
    $$
 
4. **Remainder at Max Capacity**: This is the remainder of each bar, even when it is used at maximum capacity for that length. This is calculated by:
    $$ 6 - (each \ bar \ gives \times length) $$
    and is rounded up to 2 decimal places. 
5. **Unused Capacity**: This is what is left unused that could have been used for a particular length. That is, when the bar is not used to make the maximum number of pieces it can for that length. This is calculated by: 
    $$((bar \ needed \times each \ bar \ gives) - n) \times length$$

### Grouped by model, type and lengths

<span style="color:red;">Note: leftover unusued.</span>

```{r calc-model-type-length}
bar_length = 6

# make table calculations
df_calc <-
  df %>% 
  # group by model, type and length and get tally
  group_by(model, primary, type, length) %>% 
  tally() %>% 
  ungroup() %>% 
  # calculations
  mutate(
    each_bar_gives = bar_length %/% length,
    bar_needed = ceiling(n/each_bar_gives),
    remainder_length_total = (bar_length*bar_needed) - (length*n), # also remainder_at_max_cap * bars_needed + unused capacity
    remainder_at_max_cap = round(bar_length - (each_bar_gives*length), 2),
    unused_capacity = (bar_needed*each_bar_gives - n)*length
  )

# print table
df_calc %>% 
  DT::datatable(
    colnames = c("Model", "Primary", "Type", "Length (m)", "Number of Pieces", "Each Bar Gives", "Number of Bars Needed", "Total Remainder Length (m)", "Remainder at Max Cap (m)", "Unused Capacity (m)")
  )
```

When grouped by individual models, types, and length - <span style="color:#1CA753;">the total number of bars needed are **`r sum(is.finite(df_calc$bar_needed))`** </span>.

<span style="color:red;">Alert to the observation for frame width in model W19: exceeds 6m.</span>

## Legend

```{r legend}
# get unique legend values
unique <- c("dw", "frame", 
            "front", "bottom", "top", "height", "width", "xt",
            "D", "SD", "W")

# make description vector
legend_type_explanation <- c("Doors / Windows", "Frame", 
                             "Front", "Bottom", "Top", "Height", "Width", "Extra Additions", 
                             "Doors", "Sliding Doors", "Windows")

# make tibble
legend <- tibble(unique, legend_type_explanation)

# print table
legend %>% 
  kableExtra::kable(col.names = c("Type", "Description")) %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"))
```

## Raw Data

The raw data is imported from an excel file named `material.xlsx` and can be downloaded 
[here](https://github.com/dvannanda/paktulay-doors/blob/main/data/materials.xlsx?raw=true).
